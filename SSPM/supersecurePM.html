<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon made using Twemoji (Twitter) under CC-BY 4.0 -->
    <!-- https://twemoji.twitter.com/ -->

    <link rel="apple-touch-icon-precomposed" sizes="180x180" href="../SSPM/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../SSPM/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../SSPM/favicon-16x16.png">
    <link rel="manifest" href="../SSPM/site.webmanifest">
    
    <title>SuperSecure Password Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .login-section, .manager-section {
            display: none;
        }

        .login-section.active, .manager-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="password"], input[type="text"], input[type="email"], input[type="file"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="password"]:focus, input[type="text"]:focus, input[type="email"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .password-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .password-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .password-field {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .password-field input {
            flex: 1;
            font-family: monospace;
        }

        .password-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .strength-meter {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .strength-bar {
            height: 100%;
            transition: width 0.3s, background-color 0.3s;
        }

        .strength-weak { background: #dc3545; }
        .strength-medium { background: #ffc107; }
        .strength-strong { background: #28a745; }

        .generator-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .generator-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d9ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .password-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê SuperSecure</h1>
            <p>Your Personal Password Manager with Cross-Device Sync</p>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div class="login-section active" id="loginSection">
                <h2>Master Password</h2>
                <p style="margin-bottom: 20px; color: #666;">Enter your master password to access your vault. If this is your first time, create a strong master password.</p>
                
                <div class="form-group">
                    <label for="masterPassword">Master Password</label>
                    <input type="password" id="masterPassword" placeholder="Enter your master password">
                </div>
                
                <button class="btn btn-primary" onclick="login()">Unlock Vault</button>
                <button class="btn btn-secondary" onclick="showCreateVault()">Create New Vault</button>
                
                <div id="loginAlert"></div>
            </div>

            <!-- Password Manager Section -->
            <div class="manager-section" id="managerSection">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPasswords">0</div>
                        <div>Total Passwords</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weakPasswords">0</div>
                        <div>Weak Passwords</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="strongPasswords">0</div>
                        <div>Strong Passwords</div>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <h2>Password Vault</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showAddPassword()">Add Password</button>
                        <button class="btn btn-secondary" onclick="showGenerator()">Generate Password</button>
                        <button class="btn btn-secondary" onclick="exportVault()">Export Vault</button>
                        <button class="btn btn-secondary" onclick="showImportModal()">Import Vault</button>
                        <button class="btn btn-danger" onclick="logout()">Logout</button>
                    </div>
                </div>

                <input type="text" class="search-box" id="searchBox" placeholder="Search passwords..." oninput="searchPasswords()">

                <div id="passwordList"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add Password</h2>
            
            <div class="form-group">
                <label for="siteName">Site/Service Name</label>
                <input type="text" id="siteName" placeholder="e.g., Gmail, Facebook">
            </div>
            
            <div class="form-group">
                <label for="username">Username/Email</label>
                <input type="text" id="username" placeholder="your@email.com">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Password" oninput="checkPasswordStrength()">
                <div class="strength-meter">
                    <div class="strength-bar" id="strengthBar"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes">Notes (optional)</label>
                <input type="text" id="notes" placeholder="Additional notes">
            </div>
            
            <button class="btn btn-primary" onclick="savePassword()">Save Password</button>
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Password Generator Modal -->
    <div class="modal" id="generatorModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeGeneratorModal()">&times;</span>
            <h2>Password Generator</h2>
            
            <div class="generator-section">
                <div class="form-group">
                    <label for="passwordLength">Password Length: <span id="lengthValue">16</span></label>
                    <input type="range" id="passwordLength" min="8" max="64" value="16" oninput="updateLength()">
                </div>
                
                <div class="generator-options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeUppercase" checked>
                        <label for="includeUppercase">Uppercase (A-Z)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeLowercase" checked>
                        <label for="includeLowercase">Lowercase (a-z)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeNumbers" checked>
                        <label for="includeNumbers">Numbers (0-9)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeSymbols" checked>
                        <label for="includeSymbols">Symbols (!@#$)</label>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generatePassword()">Generate Password</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="generatedPassword">Generated Password</label>
                    <div class="password-field">
                        <input type="text" id="generatedPassword" readonly>
                        <button class="btn btn-secondary" onclick="copyToClipboard('generatedPassword')">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Vault Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeImportModal()">&times;</span>
            <h2>Import Vault</h2>
            
            <div class="alert alert-info" style="margin-bottom: 20px;">
                <strong>Import Options:</strong><br>
                ‚Ä¢ <strong>Merge:</strong> Add imported passwords to your existing vault<br>
                ‚Ä¢ <strong>Replace:</strong> Replace your current vault with imported data
            </div>
            
            <div class="form-group">
                <label for="importFile">Select Vault File</label>
                <input type="file" id="importFile" accept=".json" style="border: 2px dashed #ccc;">
            </div>
            
            <div class="form-group">
                <label for="importMasterPassword">Master Password for Import File</label>
                <input type="password" id="importMasterPassword" placeholder="Enter the master password used to create this export">
            </div>
            
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <input type="radio" id="mergeOption" name="importOption" value="merge" checked>
                    <label for="mergeOption" style="margin: 0;">Merge with existing passwords</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="radio" id="replaceOption" name="importOption" value="replace">
                    <label for="replaceOption" style="margin: 0;">Replace all existing passwords</label>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="importVault()">Import Vault</button>
            <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            
            <div id="importAlert" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // Crypto utilities
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveBits', 'deriveKey']
            );
            
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptData(data, key) {
            const encoder = new TextEncoder();
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                encoder.encode(JSON.stringify(data))
            );
            
            return {
                iv: Array.from(iv),
                data: Array.from(new Uint8Array(encrypted))
            };
        }

        async function decryptData(encryptedData, key) {
            const decoder = new TextDecoder();
            const iv = new Uint8Array(encryptedData.iv);
            const data = new Uint8Array(encryptedData.data);
            
            try {
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                return JSON.parse(decoder.decode(decrypted));
            } catch (error) {
                throw new Error('Invalid master password or corrupted data');
            }
        }

        // Global variables
        let masterKey = null;
        let passwords = [];
        let currentEditIndex = -1;

        // Initialize salt if not exists
        function getSalt() {
            let salt = localStorage.getItem('vault_salt');
            if (!salt) {
                const saltArray = crypto.getRandomValues(new Uint8Array(16));
                salt = JSON.stringify(Array.from(saltArray));
                localStorage.setItem('vault_salt', salt);
            }
            return new Uint8Array(JSON.parse(salt));
        }

        // Login functionality
        async function login() {
            const masterPassword = document.getElementById('masterPassword').value;
            if (!masterPassword) {
                showAlert('loginAlert', 'Please enter your master password.', 'danger');
                return;
            }

            try {
                const salt = getSalt();
                masterKey = await deriveKey(masterPassword, salt);
                
                // Try to decrypt existing data
                const encryptedData = localStorage.getItem('vault_data');
                if (encryptedData) {
                    const decryptedData = await decryptData(JSON.parse(encryptedData), masterKey);
                    passwords = decryptedData.passwords || [];
                } else {
                    passwords = [];
                }
                
                document.getElementById('loginSection').classList.remove('active');
                document.getElementById('managerSection').classList.add('active');
                updateStats();
                renderPasswords();
                
            } catch (error) {
                showAlert('loginAlert', 'Invalid master password. Please try again.', 'danger');
            }
        }

        function showCreateVault() {
            const masterPassword = document.getElementById('masterPassword').value;
            if (!masterPassword) {
                showAlert('loginAlert', 'Please enter a master password to create a new vault.', 'danger');
                return;
            }
            
            if (masterPassword.length < 8) {
                showAlert('loginAlert', 'Master password must be at least 8 characters long.', 'danger');
                return;
            }
            
            // Create new vault
            localStorage.removeItem('vault_data');
            login();
        }

        function logout() {
            masterKey = null;
            passwords = [];
            document.getElementById('masterPassword').value = '';
            document.getElementById('managerSection').classList.remove('active');
            document.getElementById('loginSection').classList.add('active');
        }

        // Save encrypted data
        async function saveVault() {
            if (!masterKey) return;
            
            const dataToEncrypt = { passwords: passwords };
            const encryptedData = await encryptData(dataToEncrypt, masterKey);
            localStorage.setItem('vault_data', JSON.stringify(encryptedData));
        }

        // Export/Import functionality
        async function exportVault() {
            if (!masterKey || passwords.length === 0) {
                showTemporaryAlert('No passwords to export!');
                return;
            }
            
            try {
                // Create export data with metadata
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    passwordCount: passwords.length,
                    passwords: passwords
                };
                
                // Encrypt the export data with current master key
                const encryptedExport = await encryptData(exportData, masterKey);
                
                // Add salt to the export (needed for decryption)
                const fullExport = {
                    salt: Array.from(getSalt()),
                    data: encryptedExport,
                    metadata: {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        passwordCount: passwords.length
                    }
                };
                
                // Create and download the file
                const blob = new Blob([JSON.stringify(fullExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `supersecure-vault-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showTemporaryAlert(`Vault exported successfully! (${passwords.length} passwords)`);
            } catch (error) {
                showTemporaryAlert('Export failed. Please try again.');
                console.error('Export error:', error);
            }
        }
        
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
            document.getElementById('importFile').value = '';
            document.getElementById('importMasterPassword').value = '';
            document.getElementById('mergeOption').checked = true;
            document.getElementById('importAlert').innerHTML = '';
        }
        
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }
        
        async function importVault() {
            const fileInput = document.getElementById('importFile');
            const importMasterPassword = document.getElementById('importMasterPassword').value;
            const isMerge = document.getElementById('mergeOption').checked;
            
            if (!fileInput.files[0]) {
                showAlert('importAlert', 'Please select a vault file to import.', 'danger');
                return;
            }
            
            if (!importMasterPassword) {
                showAlert('importAlert', 'Please enter the master password for this vault file.', 'danger');
                return;
            }
            
            try {
                // Read the file
                const file = fileInput.files[0];
                const fileContent = await readFileAsText(file);
                const importData = JSON.parse(fileContent);
                
                // Validate file format
                if (!importData.salt || !importData.data || !importData.metadata) {
                    throw new Error('Invalid vault file format');
                }
                
                // Create key from import master password and imported salt
                const importSalt = new Uint8Array(importData.salt);
                const importKey = await deriveKey(importMasterPassword, importSalt);
                
                // Decrypt the imported data
                const decryptedImport = await decryptData(importData.data, importKey);
                const importedPasswords = decryptedImport.passwords || [];
                
                if (importedPasswords.length === 0) {
                    showAlert('importAlert', 'No passwords found in the import file.', 'danger');
                    return;
                }
                
                // Confirm the import
                const action = isMerge ? 'merge' : 'replace';
                const message = isMerge 
                    ? `Import ${importedPasswords.length} passwords and merge with your existing ${passwords.length} passwords?`
                    : `Replace your current ${passwords.length} passwords with ${importedPasswords.length} imported passwords?`;
                
                if (!confirm(message)) {
                    return;
                }
                
                // Perform the import
                if (isMerge) {
                    // Merge: Add imported passwords to existing ones
                    // Check for duplicates and handle them
                    let newPasswords = 0;
                    let duplicates = 0;
                    
                    importedPasswords.forEach(importedPassword => {
                        const isDuplicate = passwords.some(existingPassword => 
                            existingPassword.site.toLowerCase() === importedPassword.site.toLowerCase() &&
                            existingPassword.username.toLowerCase() === importedPassword.username.toLowerCase()
                        );
                        
                        if (isDuplicate) {
                            duplicates++;
                        } else {
                            passwords.push(importedPassword);
                            newPasswords++;
                        }
                    });
                    
                    showAlert('importAlert', 
                        `Import completed! Added ${newPasswords} new passwords. ${duplicates} duplicates were skipped.`, 
                        'success'
                    );
                } else {
                    // Replace: Replace all existing passwords
                    passwords = importedPasswords;
                    showAlert('importAlert', 
                        `Vault replaced successfully! Now managing ${passwords.length} passwords.`, 
                        'success'
                    );
                }
                
                // Save the updated vault and refresh the display
                await saveVault();
                renderPasswords();
                updateStats();
                
                // Close modal after a delay
                setTimeout(() => {
                    closeImportModal();
                }, 2000);
                
            } catch (error) {
                if (error.message.includes('Invalid master password')) {
                    showAlert('importAlert', 'Invalid master password for this vault file.', 'danger');
                } else if (error.message.includes('Invalid vault file')) {
                    showAlert('importAlert', 'Invalid or corrupted vault file.', 'danger');
                } else {
                    showAlert('importAlert', 'Import failed. Please check the file and try again.', 'danger');
                }
                console.error('Import error:', error);
            }
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // Password management
        function showAddPassword() {
            currentEditIndex = -1;
            document.getElementById('modalTitle').textContent = 'Add Password';
            document.getElementById('siteName').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function editPassword(index) {
            currentEditIndex = index;
            const password = passwords[index];
            document.getElementById('modalTitle').textContent = 'Edit Password';
            document.getElementById('siteName').value = password.site;
            document.getElementById('username').value = password.username;
            document.getElementById('password').value = password.password;
            document.getElementById('notes').value = password.notes || '';
            document.getElementById('passwordModal').style.display = 'block';
            checkPasswordStrength();
        }

        async function savePassword() {
            const site = document.getElementById('siteName').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const notes = document.getElementById('notes').value.trim();

            if (!site || !username || !password) {
                alert('Please fill in all required fields.');
                return;
            }

            const passwordData = {
                site: site,
                username: username,
                password: password,
                notes: notes,
                created: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            if (currentEditIndex === -1) {
                passwords.push(passwordData);
            } else {
                passwordData.created = passwords[currentEditIndex].created;
                passwords[currentEditIndex] = passwordData;
            }

            await saveVault();
            closeModal();
            renderPasswords();
            updateStats();
        }

        function deletePassword(index) {
            if (confirm('Are you sure you want to delete this password?')) {
                passwords.splice(index, 1);
                saveVault();
                renderPasswords();
                updateStats();
            }
        }

        function closeModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        // Password generator
        function showGenerator() {
            document.getElementById('generatorModal').style.display = 'block';
            generatePassword();
        }

        function closeGeneratorModal() {
            document.getElementById('generatorModal').style.display = 'none';
        }

        function updateLength() {
            const length = document.getElementById('passwordLength').value;
            document.getElementById('lengthValue').textContent = length;
        }

        function generatePassword() {
            const length = parseInt(document.getElementById('passwordLength').value);
            const includeUppercase = document.getElementById('includeUppercase').checked;
            const includeLowercase = document.getElementById('includeLowercase').checked;
            const includeNumbers = document.getElementById('includeNumbers').checked;
            const includeSymbols = document.getElementById('includeSymbols').checked;

            let charset = '';
            if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
            if (includeNumbers) charset += '0123456789';
            if (includeSymbols) charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';

            if (!charset) {
                alert('Please select at least one character type.');
                return;
            }

            let password = '';
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            
            for (let i = 0; i < length; i++) {
                password += charset[array[i] % charset.length];
            }

            document.getElementById('generatedPassword').value = password;
        }

        // Password strength checker
        function checkPasswordStrength() {
            const password = document.getElementById('password').value;
            const strengthBar = document.getElementById('strengthBar');
            
            if (!password) {
                strengthBar.style.width = '0%';
                return;
            }
            
            let score = 0;
            
            // Length check
            if (password.length >= 8) score += 25;
            if (password.length >= 12) score += 25;
            
            // Character variety checks
            if (/[a-z]/.test(password)) score += 10;
            if (/[A-Z]/.test(password)) score += 10;
            if (/[0-9]/.test(password)) score += 15;
            if (/[^A-Za-z0-9]/.test(password)) score += 15;
            
            // Update strength bar
            strengthBar.style.width = score + '%';
            strengthBar.className = 'strength-bar';
            
            if (score < 40) {
                strengthBar.classList.add('strength-weak');
            } else if (score < 70) {
                strengthBar.classList.add('strength-medium');
            } else {
                strengthBar.classList.add('strength-strong');
            }
        }

        function getPasswordStrength(password) {
            let score = 0;
            
            if (password.length >= 8) score += 25;
            if (password.length >= 12) score += 25;
            if (/[a-z]/.test(password)) score += 10;
            if (/[A-Z]/.test(password)) score += 10;
            if (/[0-9]/.test(password)) score += 15;
            if (/[^A-Za-z0-9]/.test(password)) score += 15;
            
            if (score < 40) return 'weak';
            if (score < 70) return 'medium';
            return 'strong';
        }

        // Copy to clipboard functionality
        async function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            try {
                await navigator.clipboard.writeText(element.value);
                showTemporaryAlert('Copied to clipboard!');
            } catch (err) {
                // Fallback for older browsers
                element.select();
                document.execCommand('copy');
                showTemporaryAlert('Copied to clipboard!');
            }
        }

        // Search functionality
        function searchPasswords() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const filteredPasswords = passwords.filter(password => 
                password.site.toLowerCase().includes(searchTerm) ||
                password.username.toLowerCase().includes(searchTerm) ||
                (password.notes && password.notes.toLowerCase().includes(searchTerm))
            );
            renderPasswordList(filteredPasswords);
        }

        // Render passwords
        function renderPasswords() {
            renderPasswordList(passwords);
        }

        function renderPasswordList(passwordList) {
            const passwordListElement = document.getElementById('passwordList');
            
            if (passwordList.length === 0) {
                passwordListElement.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No passwords found</h3>
                        <p>Add your first password to get started!</p>
                    </div>
                `;
                return;
            }
            
            passwordListElement.innerHTML = passwordList.map((password, index) => {
                const originalIndex = passwords.indexOf(password);
                const strength = getPasswordStrength(password.password);
                const strengthColor = strength === 'weak' ? '#dc3545' : 
                                   strength === 'medium' ? '#ffc107' : '#28a745';
                
                return `
                    <div class="password-item">
                        <h3>${escapeHtml(password.site)}</h3>
                        <div class="password-field">
                            <label style="margin-bottom: 5px; font-weight: 600;">Username:</label>
                            <input type="text" value="${escapeHtml(password.username)}" readonly>
                            <button class="btn btn-secondary" onclick="copyToClipboard('username-${originalIndex}')">Copy</button>
                        </div>
                        
                        <div class="password-field">
                            <label style="margin-bottom: 5px; font-weight: 600;">Password:</label>
                            <input type="password" id="password-${originalIndex}" value="${escapeHtml(password.password)}" readonly>
                            <button class="btn btn-secondary" onclick="togglePasswordVisibility(${originalIndex})">Show</button>
                            <button class="btn btn-secondary" onclick="copyPasswordToClipboard(${originalIndex})">Copy</button>
                        </div>
                        
                        ${password.notes ? `
                            <div style="margin-bottom: 10px;">
                                <label style="margin-bottom: 5px; font-weight: 600;">Notes:</label>
                                <div style="padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
                                    ${escapeHtml(password.notes)}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 10px;">
                            <small style="color: #666;">
                                Strength: <span style="color: ${strengthColor}; font-weight: 600;">${strength.toUpperCase()}</span> | 
                                Created: ${new Date(password.created).toLocaleDateString()}
                                ${password.lastModified !== password.created ? 
                                    ` | Modified: ${new Date(password.lastModified).toLocaleDateString()}` : ''}
                            </small>
                        </div>
                        
                        <div class="password-actions">
                            <button class="btn btn-secondary" onclick="editPassword(${originalIndex})">Edit</button>
                            <button class="btn btn-danger" onclick="deletePassword(${originalIndex})">Delete</button>
                        </div>
                        
                        <!-- Hidden username input for copying -->
                        <input type="hidden" id="username-${originalIndex}" value="${escapeHtml(password.username)}">
                    </div>
                `;
            }).join('');
        }

        function togglePasswordVisibility(index) {
            const passwordInput = document.getElementById(`password-${index}`);
            const button = passwordInput.nextElementSibling;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                button.textContent = 'Hide';
            } else {
                passwordInput.type = 'password';
                button.textContent = 'Show';
            }
        }

        async function copyPasswordToClipboard(index) {
            const password = passwords[index].password;
            try {
                await navigator.clipboard.writeText(password);
                showTemporaryAlert('Password copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy password:', err);
                showTemporaryAlert('Failed to copy password');
            }
        }

        // Update statistics
        function updateStats() {
            const total = passwords.length;
            let weak = 0, strong = 0;
            
            passwords.forEach(password => {
                const strength = getPasswordStrength(password.password);
                if (strength === 'weak') weak++;
                else if (strength === 'strong') strong++;
            });
            
            document.getElementById('totalPasswords').textContent = total;
            document.getElementById('weakPasswords').textContent = weak;
            document.getElementById('strongPasswords').textContent = strong;
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
        }

        function showTemporaryAlert(message, duration = 3000) {
            // Create temporary alert element
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            alert.textContent = message;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(alert);
            
            // Remove after duration
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, duration);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Enter key login
            document.getElementById('masterPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                const modals = ['passwordModal', 'generatorModal', 'importModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Auto-generate password on page load for generator
            document.getElementById('passwordLength').addEventListener('input', generatePassword);
            document.getElementById('includeUppercase').addEventListener('change', generatePassword);
            document.getElementById('includeLowercase').addEventListener('change', generatePassword);
            document.getElementById('includeNumbers').addEventListener('change', generatePassword);
            document.getElementById('includeSymbols').addEventListener('change', generatePassword);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K for search focus
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchBox = document.getElementById('searchBox');
                if (searchBox && searchBox.style.display !== 'none') {
                    searchBox.focus();
                }
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                const modals = ['passwordModal', 'generatorModal', 'importModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
            }
        });
        // Auto-logout after 5 minutes of inactivity
        let logoutTimer = setTimeout(logout, 5 * 60 * 1000);
        document.addEventListener('mousemove', resetLogoutTimer);
        document.addEventListener('keydown', resetLogoutTimer);

        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(logout, 5 * 60 * 1000);
        }

        // Clipboard auto-clear warning
        async function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            try {
                await navigator.clipboard.writeText(element.value);
                showTemporaryAlert('Copied to clipboard! Clear clipboard when done.');

                // Attempt to clear clipboard after 15 seconds (if allowed)
                setTimeout(async () => {
                    try {
                        await navigator.clipboard.writeText('');
                        showTemporaryAlert('Clipboard cleared.');
                    } catch (e) {
                        console.warn('Clipboard clear failed');
                    }
                }, 15000);
            } catch (err) {
                // Fallback for older browsers
                element.select();
                document.execCommand('copy');
                showTemporaryAlert('Copied to clipboard!');
            }
        }

        // Patch clipboard copyPasswordToClipboard with same protection
        async function copyPasswordToClipboard(index) {
            const password = passwords[index].password;
            try {
                await navigator.clipboard.writeText(password);
                showTemporaryAlert('Password copied! Clear clipboard when done.');

                setTimeout(async () => {
                    try {
                        await navigator.clipboard.writeText('');
                        showTemporaryAlert('Clipboard cleared.');
                    } catch (e) {
                        console.warn('Clipboard clear failed');
                    }
                }, 15000);
            } catch (err) {
                console.error('Failed to copy password:', err);
                showTemporaryAlert('Failed to copy password');
            }
        }
    </script>
</body>
</html>
